<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=6.4.1">


  <link rel="mask-icon" href="/logo.svg?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.4.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Reference 持续集成服务 Travis CI 教程 SSH deploys with Travis CI Auto-Deploying via Travis CI Encrypting Files - Travis CI  前言CI(持续集成) 是什么 In software engineering, continuous integration (CI) is the practice">
<meta property="og:type" content="article">
<meta property="og:title" content="为 GitHub 项目配置持续集成 (CI)">
<meta property="og:url" content="http://yoursite.com/2018/04/10/2018-04-10-travis-ci-tutorial/index.html">
<meta property="og:site_name" content="DaddyTrap&#39;s blog">
<meta property="og:description" content="Reference 持续集成服务 Travis CI 教程 SSH deploys with Travis CI Auto-Deploying via Travis CI Encrypting Files - Travis CI  前言CI(持续集成) 是什么 In software engineering, continuous integration (CI) is the practice">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/assets/travis_ci_tutorial/sign_in.png">
<meta property="og:image" content="http://yoursite.com/assets/travis_ci_tutorial/repo_list.png">
<meta property="og:image" content="http://yoursite.com/assets/travis_ci_tutorial/authorized_keys.png">
<meta property="og:image" content="http://yoursite.com/assets/travis_ci_tutorial/commit-log.png">
<meta property="og:updated_time" content="2018-09-30T13:18:11.672Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="为 GitHub 项目配置持续集成 (CI)">
<meta name="twitter:description" content="Reference 持续集成服务 Travis CI 教程 SSH deploys with Travis CI Auto-Deploying via Travis CI Encrypting Files - Travis CI  前言CI(持续集成) 是什么 In software engineering, continuous integration (CI) is the practice">
<meta name="twitter:image" content="http://yoursite.com/assets/travis_ci_tutorial/sign_in.png">






  <link rel="canonical" href="http://yoursite.com/2018/04/10/2018-04-10-travis-ci-tutorial/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>为 GitHub 项目配置持续集成 (CI) | DaddyTrap's blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">DaddyTrap's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/10/2018-04-10-travis-ci-tutorial/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="DaddyTrap/PlusC">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="DaddyTrap's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">为 GitHub 项目配置持续集成 (CI)
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-04-10 11:02:26" itemprop="dateCreated datePublished" datetime="2018-04-10T11:02:26+08:00">2018-04-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2018-09-30 21:18:11" itemprop="dateModified" datetime="2018-09-30T21:18:11+08:00">2018-09-30</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Tutorial-Github/" itemprop="url" rel="index"><span itemprop="name">Tutorial Github</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a href="http://www.ruanyifeng.com/blog/2017/12/travis_ci_tutorial.html" target="_blank" rel="noopener">持续集成服务 Travis CI 教程</a></li>
<li><a href="https://oncletom.io/2016/travis-ssh-deploy/" target="_blank" rel="noopener">SSH deploys with Travis CI</a></li>
<li><a href="https://gist.github.com/nickbclifford/16c5be884c8a15dca02dca09f65f97bd" target="_blank" rel="noopener">Auto-Deploying via Travis CI</a></li>
<li><a href="https://docs.travis-ci.com/user/encrypting-files/#Using-OpenSSL" target="_blank" rel="noopener">Encrypting Files - Travis CI</a></li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="CI-持续集成-是什么"><a href="#CI-持续集成-是什么" class="headerlink" title="CI(持续集成) 是什么"></a><a href="https://en.wikipedia.org/wiki/Continuous_integration" target="_blank" rel="noopener">CI(持续集成)</a> 是什么</h3><blockquote>
<p>In software engineering, continuous integration (CI) is the practice of merging all developer working copies to a shared mainline several times a day.</p>
</blockquote>
<blockquote>
<p>大意: 在软件工程中，持续集成是一种这样的实践: 一天中多次将所有开发者的工作副本整合到一个共享的主线上。</p>
</blockquote>
<a id="more"></a>
<h3 id="用来做什么"><a href="#用来做什么" class="headerlink" title="用来做什么"></a>用来做什么</h3><p>虽然上面可能看的是云里雾里，但是我们可以直接说出 CI 可以用来做什么。</p>
<p>在 GitHub 中，使用最多的 CI 服务是 <a href="https://travis-ci.org/" target="_blank" rel="noopener">Travis CI</a>，其作用就是在 Git 仓库代码发生更改时(push/accept pull request/…)，执行一系列(一般)用于 <strong>测试(Test)</strong>、<strong>构建(Build)</strong> 的命令，以此完成自动构建、自动测试的工作。</p>
<h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><ul>
<li>GitHub账号</li>
<li>需要配置CI的仓库</li>
</ul>
<h2 id="Travis-CI-页面"><a href="#Travis-CI-页面" class="headerlink" title="Travis CI 页面"></a>Travis CI 页面</h2><p>访问 <a href="https://travis-ci.org/" target="_blank" rel="noopener">https://travis-ci.org/</a> 点击右上角的 <code>Sign in with GitHub</code> 使用 GitHub 账号登录 Travis CI</p>
<p><img src="/assets/travis_ci_tutorial/sign_in.png" alt=""></p>
<p>登入后，页面会列出你的仓库，如果没有的话，应该找到左侧栏的 <code>My Repositories</code> 隔壁的加号，就可以看到。将其中想要使用 CI 的仓库的开关打开，那么 Travis CI 就会对这个仓库的 <strong>更改</strong> 有响应。</p>
<p><img src="/assets/travis_ci_tutorial/repo_list.png" alt=""></p>
<p>在这里我选择了自己的 <code>learngit</code> 为例。</p>
<h2 id="travis-yml"><a href="#travis-yml" class="headerlink" title=".travis.yml"></a>.travis.yml</h2><p><code>.travis.yml</code> 文件需要放在项目的 <strong>根目录</strong>，其中的内容就是 CI 最核心的部分，包含着对 CI 过程的描述(如项目使用的语言、在相应阶段执行的脚本等等)</p>
<p>关于 <code>travis.yml</code> 的具体语法，可以参考 travis 的 <a href="https://docs.travis-ci.com/user/getting-started/" target="_blank" rel="noopener">官方 guide</a></p>
<p>在此，我们暂且依葫芦画瓢</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">python</span></span><br><span class="line"><span class="attr">python:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">'3.6'</span></span><br><span class="line"><span class="attr">sudo:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>上面的意思是，项目使用 python3.6，执行 CI 不需要 sudo 权限</p>
<blockquote>
<p>选用不同的language导致的结果是会有不同的默认 install/script 设置</p>
</blockquote>
<p>但是仅有上面的设置，不足以描述 CI 过程，比如具体如何 <strong>测试</strong>、如何 <strong>构建</strong> 都没有提到，因此到这还不够，且看下面部分</p>
<h2 id="Travis-CI-流程"><a href="#Travis-CI-流程" class="headerlink" title="Travis CI 流程"></a>Travis CI 流程</h2><h3 id="必经阶段"><a href="#必经阶段" class="headerlink" title="必经阶段"></a>必经阶段</h3><p>对于项目必定有两个阶段，即</p>
<ul>
<li>install 阶段 - 安装依赖</li>
<li>script 阶段 - 运行脚本</li>
</ul>
<p>实际上，两个阶段就是一组命令的列表，而其不同之处在于</p>
<ul>
<li>在 install 阶段，只要有一个命令失败，就会终止 CI，并认为失败</li>
<li>在 script 阶段，如果有一个命令失败，不会终止 CI，而是继续执行下一条命令，但最后还是认为失败</li>
</ul>
<p>另外，如果想要跳过这两种阶段，则如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">install:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">script:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>两行可以不同时出现</p>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h4 id="Python-项目"><a href="#Python-项目" class="headerlink" title="Python 项目"></a>Python 项目</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">install:</span> <span class="string">pip</span> <span class="string">install</span> <span class="bullet">-r</span> <span class="string">requirements.txt</span></span><br><span class="line"><span class="attr">script:</span> <span class="string">pytest</span></span><br></pre></td></tr></table></figure>
<p>上面是单条指令的例子</p>
<h4 id="Node-js-项目"><a href="#Node-js-项目" class="headerlink" title="Node.js 项目"></a>Node.js 项目</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">install:</span> <span class="string">npm</span> <span class="string">i</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">node</span> <span class="string">test1.js</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">node</span> <span class="string">test2.js</span></span><br></pre></td></tr></table></figure>
<p>多条指令的用法如上</p>
<h3 id="Deploy-部署-阶段"><a href="#Deploy-部署-阶段" class="headerlink" title="Deploy(部署) 阶段"></a>Deploy(部署) 阶段</h3><p>部署阶段并不是一个必经的阶段，不需要(且不能)用 <code>deploy: true</code> 来跳过，只要不写就没有 <code>deploy</code> 阶段。</p>
<p>Travis CI 已经为一些常用的部署做好了支持，具体可以参阅 <a href="https://docs.travis-ci.com/user/deployment/" target="_blank" rel="noopener">官方文档</a>，如 GitHub Pages 的部署</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  provider:</span> <span class="string">pages</span></span><br><span class="line"><span class="attr">  skip-cleanup:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  github-token:</span> <span class="string">$GITHUB_TOKEN</span>  <span class="comment"># Set in travis-ci.org dashboard, marked secure</span></span><br><span class="line"><span class="attr">  on:</span></span><br><span class="line"><span class="attr">    branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
<p>上面的意思是</p>
<ul>
<li>使用 <code>pages</code> 的部署方法 (provider即“提供该服务的人”)</li>
<li>跳过 删除构建的文件 的动作</li>
<li>使用的 github-token</li>
<li>在 master 分支才会执行这个部署</li>
</ul>
<div id="deploy-script">

<p>有一种稍有点特殊的部署方法是 <code>script</code>，它并不是由某个服务提供商提供，而是就是执行一段 <strong>script</strong> 来部署，如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  provider:</span> <span class="string">script</span></span><br><span class="line"><span class="attr">  script:</span> <span class="string">bash</span> <span class="string">scripts/deploy.sh</span></span><br><span class="line"><span class="attr">  on:</span></span><br><span class="line"><span class="attr">    branch:</span> <span class="string">develop</span></span><br></pre></td></tr></table></figure>
<ul>
<li>执行命令 <code>bash scripts/deploy.sh</code></li>
<li>在 develop 分支才会执行这个部署</li>
</ul>
<h3 id="阶段Hook"><a href="#阶段Hook" class="headerlink" title="阶段Hook"></a>阶段Hook</h3><p>所谓Hook其实就是对应每个阶段，可以在每个阶段 之前/之后 等，执行一组指令，所有的Hook如下</p>
<ul>
<li>before_install：install 阶段之前执行</li>
<li>before_script：script 阶段之前执行</li>
<li>after_failure：script 阶段失败时执行</li>
<li>after_success：script 阶段成功时执行</li>
<li>before_deploy：deploy 步骤之前执行</li>
<li>after_deploy：deploy 步骤之后执行</li>
<li>after_script：script 阶段之后执行</li>
</ul>
<p>完整的流程如下</p>
<ol>
<li>before_install</li>
<li>install</li>
<li>before_script</li>
<li>script</li>
<li>aftersuccess or afterfailure</li>
<li>[OPTIONAL] before_deploy</li>
<li>[OPTIONAL] deploy</li>
<li>[OPTIONAL] after_deploy</li>
<li>after_script</li>
</ol>
<p>678 的 [OPTIONAL] 的意思是，deploy 是可以不执行的，而当 deploy 不执行时，68 也不会执行</p>
<p>通过下面这个 <code>.travis.yml</code> 可以清楚地看到阶段的顺序</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">python</span></span><br><span class="line"><span class="attr">sudo:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">before_install:</span> <span class="string">echo</span> <span class="string">"`date` - travis CI build"</span></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">echo</span> <span class="string">"install"</span></span><br><span class="line"><span class="attr">before_script:</span> <span class="string">echo</span> <span class="string">"before_script"</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">echo</span> <span class="string">"script"</span></span><br><span class="line"><span class="attr">after_failure:</span> <span class="string">echo</span> <span class="string">"after_failure"</span></span><br><span class="line"><span class="attr">after_success:</span> <span class="string">echo</span> <span class="string">"after_success"</span></span><br><span class="line"><span class="attr">before_deploy:</span> <span class="string">echo</span> <span class="string">"before_deploy"</span></span><br><span class="line"><span class="attr">after_deploy:</span> <span class="string">echo</span> <span class="string">"after_deploy"</span></span><br><span class="line"><span class="attr">after_script:</span> <span class="string">echo</span> <span class="string">"after_script"</span></span><br></pre></td></tr></table></figure>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p><strong>一般地</strong>，在 install 阶段执行 <strong>依赖安装</strong>，在 script 阶段执行 <strong>运行脚本</strong> —— 一般是运行 <strong>测试+构建</strong> 脚本，在 deploy 阶段执行 <strong>部署</strong>。</p>
<p>然而，不难看出，只要清楚流程顺序，我们想怎么搞怎么搞，因此这些流程的名字可以只作参考，具体怎么玩，还是看自己</p>
<h2 id="自动部署到自己的云服务器"><a href="#自动部署到自己的云服务器" class="headerlink" title="自动部署到自己的云服务器"></a>自动部署到自己的云服务器</h2><p><code>deploy</code> 阶段可以通过设置 <code>provider</code> 字段来表示将服务部署到各种服务提供商，但是如果想部署到自己的云服务器，要怎么办呢？</p>
<p>Travis CI 实际上是一个第三方的 <strong>CI runner</strong>，其工作就是监测仓库的变动，当仓库有变动时执行配置的脚本。而我之前是使用过 <strong>gitlab</strong> 的 CI runner，其原理就是通过 HTTP 轮询 gitlab，发现变动时执行脚本。gitlab-runner 是放在自己的服务器的，当然就可以通过脚本把项目部署到本地；但是 travis 则不是这样的，所以下面就看看，需要怎样的操作。</p>
<h3 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h3><p>部署到远程服务器，需要考虑这些问题</p>
<ul>
<li>如何登录到远程服务器<ul>
<li>使用密码登录</li>
<li>使用ssh密钥登录</li>
</ul>
</li>
<li>如何在远程服务器执行脚本<ul>
<li>使用ssh</li>
</ul>
</li>
</ul>
<h3 id="配置ssh密钥"><a href="#配置ssh密钥" class="headerlink" title="配置ssh密钥"></a>配置ssh密钥</h3><p>登录到远程服务器的两种手段中，使用密码登录，就会使得密码出现在 <code>.travis.yml</code> 的明文中；使用ssh密钥登录，又需要把私钥文件推到远程仓库。而远程仓库有很大的可能是public的，这样就会出现重大的安全问题。</p>
<p>所幸 travis 提供了一种解决的方法，那就是 <code>travis encrypt</code> 。使用 <code>travis encrypt</code> 可以生成加密的环境变量、使用 <code>travis encrypt-file</code> 可以生成加密的文件，这一个 <strong>加密</strong> 只有 travis 能解开，也就是说只要你信任 travis，那么就不用忧虑安全问题啦！(笑)</p>
<p>那么就开始吧</p>
<h4 id="生成、配置RSA密钥"><a href="#生成、配置RSA密钥" class="headerlink" title="生成、配置RSA密钥"></a>生成、配置RSA密钥</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -C <span class="string">'build@travis-ci.org'</span> -f ./deploy_rsa</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果使用的是 Windows 系统，推荐在 Git Bash 中使用上述指令</p>
</blockquote>
<p>执行过程中，会询问是否要使用 <code>passphrase</code>，在此为方便起见我们不进行设置，直接 enter 跳过</p>
<p>执行完毕，就会在目录下发现两个新的文件 <code>deploy_rsa</code> 和 <code>deploy_rsa.pub</code>。记得我看过一篇博客说过 “公钥可以公开出去给别人看，私钥打死都不要送出去！”，就是这么个道理。<code>deploy_rsa.pub</code> 的内容是可以公开的，而私钥 <code>deploy_rsa</code> 则绝对 <strong>不能</strong> 公开。</p>
<p>为了“免密码”登录，我们需要把 <code>deploy_rsa.pub</code> 的内容添加到云服务器的 <code>~/.ssh/authorized_keys</code> 中，如果没有这个目录/文件，可以自己创建</p>
<p>此处的 <code>~</code> 表示 <code>/home/&lt;username&gt;</code>，想要哪个用户免密码登录，就放在哪个用户的主目录下，安全起见，个人推荐为 travis 创建一个新的用户</p>
<p><img src="/assets/travis_ci_tutorial/authorized_keys.png" alt=""></p>
<h4 id="加密私钥文件"><a href="#加密私钥文件" class="headerlink" title="加密私钥文件"></a>加密私钥文件</h4><h5 id="安装-Travis-工具"><a href="#安装-Travis-工具" class="headerlink" title="安装 Travis 工具"></a>安装 Travis 工具</h5><p>首先需要 ruby 环境，如果之前配置过 GitHub Pages + jekyll 应该没有问题</p>
<p>关于 Ruby 的安装，可以参考鄙人另一篇博客的<a href="/tutorial/2017/10/01/setup-jekyll-gh-pages.html#Ruby">一部分</a></p>
<p>安装 Travis 工具只需一条命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem install travis <span class="comment"># 或许需要 sudo</span></span><br></pre></td></tr></table></figure>
<h5 id="登录-Travis"><a href="#登录-Travis" class="headerlink" title="登录 Travis"></a>登录 Travis</h5><blockquote>
<p>在 Windows 下使用，<strong>不</strong> 推荐用 Git Bash 来执行 travis，个人使用时遇到了各种神奇bug……</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">travis login</span><br></pre></td></tr></table></figure>
<p>稍等片刻，就会提示输入用户名和密码</p>
<hr>
<blockquote>
<p>网上提供的多是 <strong>非Windows</strong> 系统的加密方法，然而 Windows 系统的 <code>travis encrypt-file</code> <a href="https://github.com/travis-ci/travis-ci/issues/4746" target="_blank" rel="noopener">并不正常(2018.4.11)</a>，因此这里采用两种方法</p>
</blockquote>
<hr>
<h5 id="非Windows"><a href="#非Windows" class="headerlink" title="非Windows"></a>非Windows</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">travis encrypt-file deploy_rsa --add</span><br></pre></td></tr></table></figure>
<p><code>--add</code> 会把解密时需要的命令放到 <code>before_install</code> 中，根据需要，可以把这条指令放到其他阶段</p>
<h5 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h5><p>由于上面提到的bug，Windows 的操作稍显复杂</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">travis encrypt rsa_password=ahduQu9ushou0Roh --add</span><br><span class="line">openssl aes-256-cbc -k <span class="string">"ahduQu9ushou0Roh"</span> -<span class="keyword">in</span> deploy_rsa -out deploy_rsa.enc</span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面的环境变量名 <code>rsa_password</code> 和 密码 <code>ahduQu9ushou0Roh</code> 可以自行替换为自定的内容</p>
</blockquote>
<p>这样就完成了加密的步骤，然后手动在 <code>.travis.yml</code> 中添加解密脚本</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">before_deploy:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">openssl</span> <span class="string">aes-256-cbc</span> <span class="bullet">-k</span> <span class="string">"$rsa_password"</span> <span class="bullet">-in</span> <span class="string">deploy_rsa.enc</span> <span class="bullet">-out</span> <span class="string">deploy_rsa</span> <span class="bullet">-d</span></span><br></pre></td></tr></table></figure>
<p>这样，travis 在 deploy 阶段前就会解密密钥文件。</p>
<p>至此，完成了 <strong>配置ssh密钥</strong> 的阶段</p>
<h3 id="使用ssh密钥"><a href="#使用ssh密钥" class="headerlink" title="使用ssh密钥"></a>使用ssh密钥</h3><p>在上面的步骤中，我们已经可以解密出私钥了，那么接下来要用私钥建立ssh连接</p>
<p>修改 <code>.travis.yml</code>，加入以下的行</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">addons:</span></span><br><span class="line"><span class="attr">  ssh_known_hosts:</span> <span class="string">&lt;deploy-host&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">before_deploy:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">openssl</span> <span class="string">aes-256-cbc</span> <span class="bullet">-K</span> <span class="string">$encrypted_&lt;...&gt;_key</span> <span class="bullet">-iv</span> <span class="string">$encrypted_&lt;...&gt;_iv</span> <span class="bullet">-in</span> <span class="string">deploy_rsa.enc</span> <span class="bullet">-out</span> <span class="string">/tmp/deploy_rsa</span> <span class="bullet">-d</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">eval</span> <span class="string">"$(ssh-agent -s)"</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">chmod</span> <span class="number">600</span> <span class="string">/tmp/deploy_rsa</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ssh-add</span> <span class="string">/tmp/deploy_rsa</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>&lt;deploy-host&gt;</code> 即远程服务器的地址</li>
<li>要注意 <code>openssl</code> 解密的一行中，要把 <code>-out</code> 后的路径改为 <code>/tmp/deploy_rsa</code> (把解密后的私钥放到 <code>/tmp</code>，防止把明文私钥部署到其他地方)</li>
<li>使用 <code>travis encrypt-file xxxx --add</code> 时，<code>openssl</code> 解密会被生成在 <code>before_install</code> 中，此处把它放到 <code>before_deploy</code> 中，是因为 <code>before_deploy</code> 是在确定 <strong>成功</strong> 完成了 install/script 的两个阶段才会执行的，而我们的需求也应该是，前两个阶段完成才有必要解密文件</li>
</ul>
<h3 id="编写部署脚本"><a href="#编写部署脚本" class="headerlink" title="编写部署脚本"></a>编写部署脚本</h3><p>你可还记得有一种比较特别的 <code>deploy provider</code> 叫做 <a href="#deploy-script"><code>script</code></a> ？</p>
<p>这里我们就用它来实现部署。</p>
<p>修改 <code>.travis.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  provider:</span> <span class="string">script</span></span><br><span class="line"><span class="attr">  skip_cleanup:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  script:</span> <span class="string">bash</span> <span class="string">deploy.sh</span></span><br><span class="line"><span class="attr">  on:</span></span><br><span class="line"><span class="attr">    branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面的意思，可以参阅本文的前半部分</p>
</blockquote>
<p>显然，我们还需要编写 <code>deploy.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file: deploy.sh</span></span><br><span class="line">ssh travis@daddytrapc.cn &lt;&lt; <span class="string">'ENDSSH'</span></span><br><span class="line">  <span class="comment"># Here starts the script in the remote machine</span></span><br><span class="line">  <span class="built_in">cd</span> /home/travis</span><br><span class="line">  git <span class="built_in">clone</span> https://github.com/DaddyTrap/learngit.git</span><br><span class="line">  <span class="built_in">cd</span> learngit</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"`date` - Deploy script running..."</span> &gt;&gt; travis.log</span><br><span class="line">  <span class="comment"># Do something here</span></span><br><span class="line">  python3 test.py</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"`date` - Deploy script done!"</span> &gt;&gt; travis.log</span><br><span class="line">ENDSSH</span><br></pre></td></tr></table></figure>
<p>根据不同的项目部署方法，只要改写 <code>&#39;ENDSSH&#39;</code> 和 <code>ENDSSH</code> <strong>之间的</strong>部分即可</p>
<hr>
<p>到这里，就可以 <code>git add/commit/push</code>，然后 BOOM，就可以在 <a href="https://travis-ci.org/" target="_blank" rel="noopener">https://travis-ci.org/</a> 看到你的构建过程了</p>
<p>—— 然而，<strong>切记</strong>，<strong>不要</strong> add 私钥文件，如果你真的不小心做了这样的事情，那就重新生成一份吧！</p>
<blockquote>
<p>你只需要add <code>deploy_rsa.enc</code>，而至于私钥文件和公钥文件，在配置好之后就可以都删掉了</p>
</blockquote>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>为了能自动部署到远程的服务器，还是挺折腾的，为此我还经历了多次尝试性的commit呢……</p>
<p><img src="/assets/travis_ci_tutorial/commit-log.png" alt=""></p>
<p>但是自动部署还是一件很能提高开发效率的事情，所以也不妨折腾折腾吧！</p>
</div>
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/26/2018-03-26-c++-final-class/" rel="next" title="C++实现final类(不可被继承的类)">
                <i class="fa fa-chevron-left"></i> C++实现final类(不可被继承的类)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/04/14/2018-04-14-homework-sad-4/" rel="prev" title="系统分析与设计 第四次作业(lesson6)">
                系统分析与设计 第四次作业(lesson6) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">DaddyTrap/PlusC</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">34</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">1.</span> <span class="nav-text">Reference</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">2.</span> <span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CI-持续集成-是什么"><span class="nav-number">2.1.</span> <span class="nav-text">CI(持续集成) 是什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#用来做什么"><span class="nav-number">2.2.</span> <span class="nav-text">用来做什么</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#前置"><span class="nav-number">3.</span> <span class="nav-text">前置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Travis-CI-页面"><span class="nav-number">4.</span> <span class="nav-text">Travis CI 页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#travis-yml"><span class="nav-number">5.</span> <span class="nav-text">.travis.yml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Travis-CI-流程"><span class="nav-number">6.</span> <span class="nav-text">Travis CI 流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#必经阶段"><span class="nav-number">6.1.</span> <span class="nav-text">必经阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实例"><span class="nav-number">6.2.</span> <span class="nav-text">实例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Python-项目"><span class="nav-number">6.2.1.</span> <span class="nav-text">Python 项目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Node-js-项目"><span class="nav-number">6.2.2.</span> <span class="nav-text">Node.js 项目</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deploy-部署-阶段"><span class="nav-number">6.3.</span> <span class="nav-text">Deploy(部署) 阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#阶段Hook"><span class="nav-number">6.4.</span> <span class="nav-text">阶段Hook</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#思考"><span class="nav-number">6.5.</span> <span class="nav-text">思考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自动部署到自己的云服务器"><span class="nav-number">7.</span> <span class="nav-text">自动部署到自己的云服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总览"><span class="nav-number">7.1.</span> <span class="nav-text">总览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置ssh密钥"><span class="nav-number">7.2.</span> <span class="nav-text">配置ssh密钥</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#生成、配置RSA密钥"><span class="nav-number">7.2.1.</span> <span class="nav-text">生成、配置RSA密钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#加密私钥文件"><span class="nav-number">7.2.2.</span> <span class="nav-text">加密私钥文件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#安装-Travis-工具"><span class="nav-number">7.2.2.1.</span> <span class="nav-text">安装 Travis 工具</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#登录-Travis"><span class="nav-number">7.2.2.2.</span> <span class="nav-text">登录 Travis</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#非Windows"><span class="nav-number">7.2.2.3.</span> <span class="nav-text">非Windows</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Windows"><span class="nav-number">7.2.2.4.</span> <span class="nav-text">Windows</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用ssh密钥"><span class="nav-number">7.3.</span> <span class="nav-text">使用ssh密钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写部署脚本"><span class="nav-number">7.4.</span> <span class="nav-text">编写部署脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后记"><span class="nav-number">8.</span> <span class="nav-text">后记</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DaddyTrap/PlusC</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Muse</a> v6.4.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
